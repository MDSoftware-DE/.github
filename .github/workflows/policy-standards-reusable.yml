name: policy/standards (reusable)

on:
  workflow_call:
    inputs:
      require_issue_reference:
        description: Require issue reference in PR title or body
        required: false
        default: true
        type: boolean
      require_english_checkbox:
        description: Require checked English confirmation checkbox from PR template
        required: false
        default: true
        type: boolean
      enforce_template_sections:
        description: Require standard PR template sections
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    name: policy/standards
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
    steps:
      - name: Validate PR metadata policy
        uses: actions/github-script@v7
        env:
          REQUIRE_ISSUE_REFERENCE: ${{ inputs.require_issue_reference }}
          REQUIRE_ENGLISH_CHECKBOX: ${{ inputs.require_english_checkbox }}
          ENFORCE_TEMPLATE_SECTIONS: ${{ inputs.enforce_template_sections }}
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request payload found.");
              return;
            }

            const title = (pr.title || "").trim();
            const body = (pr.body || "").trim();
            const failures = [];

            if (!title) failures.push("PR title is empty.");
            if (!body) failures.push("PR body is empty.");

            const requireSections = String(process.env.ENFORCE_TEMPLATE_SECTIONS) === "true";
            if (requireSections) {
              const requiredHeadings = [
                "## Summary",
                "## Related Issue",
                "## Verification",
                "## Checklist",
              ];
              for (const heading of requiredHeadings) {
                if (!body.includes(heading)) failures.push(`Missing section: ${heading}`);
              }
            }

            const requireIssueRef = String(process.env.REQUIRE_ISSUE_REFERENCE) === "true";
            if (requireIssueRef) {
              const issuePattern = /(^|\s)#\d+\b|https:\/\/github\.com\/[^/]+\/[^/]+\/issues\/\d+/i;
              if (!issuePattern.test(title) && !issuePattern.test(body)) {
                failures.push("No related issue reference found (example: #123).");
              }
            }

            const requireEnglishCheckbox = String(process.env.REQUIRE_ENGLISH_CHECKBOX) === "true";
            if (requireEnglishCheckbox) {
              const checkboxPattern = /- \[[xX]\] I confirm this PR title and description are written in English\./;
              if (!checkboxPattern.test(body)) {
                failures.push("English confirmation checkbox is not checked in PR checklist.");
              }
            }

            if (failures.length > 0) {
              core.setFailed(failures.join("\n"));
            } else {
              core.info("PR metadata policy checks passed.");
            }
